on:
  push:
    branches: [ swing ]

jobs:

  build-linux:
    if: contains(github.event.head_commit.message, '#go')
    runs-on: ubuntu-latest   # ✅ Linux runner
    steps:
      - uses: actions/checkout@v3

      - name: Set up Git user
        run: |
          git config --global user.name "rajumark"
          git config --global user.email "raju348636@gmail.com"

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'adopt'
          java-version: '17'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build

      - name: Package for Linux
        run: ./gradlew :packageDistributionForCurrentOS

      - name: Debug – list generated files
        run: |
          echo "=== Generated files inside build/compose ==="
          ls -R build/compose || true

          echo "=== Searching for .deb files ==="
          find build/compose -type f -name "*.deb" || true

      - name: Publish to Private Repo
        env:
          PRIVATE_REPO_TOKEN: ${{ secrets.PRIVATE_REPO_PAT }}
        run: |
          current_dir=$(pwd)
          file_path="./build.gradle.kts"
          version=$(grep -oE 'packageVersion = "[0-9]+\.[0-9]+\.[0-9]+"' $file_path | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')

          echo "Current version: $version"

          # dynamically detect the .deb file
          deb_file_path=$(find "$current_dir/build/compose/binaries/main/deb" -type f -name "*.deb" | head -n 1)

          if [ -f "$deb_file_path" ]; then
            echo "DEB file path: $deb_file_path"

            git clone https://${{ secrets.PRIVATE_REPO_PAT }}@github.com/rajumark/Tidefish-Releases.git

            target_dir="Tidefish-Releases/linux"
            if [ -d "$target_dir" ]; then
              echo "Cleaning existing files in $target_dir"
              rm -rf "$target_dir"/*
            fi

            mkdir -p "$target_dir"
            cp "$deb_file_path" "$target_dir/"

            cd Tidefish-Releases
            git add .
            git commit -m "Update Linux: $version" || echo "No changes to commit"

            # ✅ Ensure we are up-to-date before pushing
            git pull --rebase origin main

            git push https://${{ secrets.PRIVATE_REPO_PAT }}@github.com/rajumark/Tidefish-Releases.git
          else
            echo "No .deb package found in build output."
          fi
